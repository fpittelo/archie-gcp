<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- End Cache Control Meta Tags -->

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Archie Query Page</title>

    <link rel="icon" type="image/png" sizes="228x228" href="frontend/favicons/favicon-228.png">
    <link rel="icon" type="image/png" sizes="180x180" href="frontend/favicons/favicon-180.png">
    <link rel="icon" type="image/png" sizes="152x152" href="frontend/favicons/favicon-152.png">
    <link rel="icon" type="image/png" sizes="144x144" href="frontend/favicons/favicon-144.png">
    <link rel="icon" type="image/png" sizes="128x128" href="frontend/favicons/favicon-128.png">
    <link rel="icon" type="image/png" sizes="120x120" href="frontend/favicons/favicon-120.png">
    <link rel="icon" type="image/png" sizes="96x96" href="frontend/favicons/favicon-96.png">
    <link rel="icon" type="image/png" sizes="76x76" href="frontend/favicons/favicon-76.png">
    <link rel="icon" type="image/png" sizes="57x57" href="frontend/favicons/favicon-57.png">
    <link rel="icon" type="image/png" sizes="32x32" href="frontend/favicons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="frontend/favicons/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="frontend/favicons/apple-touch-icon.png">
    <link rel="manifest" href="frontend/favicons/site.webmanifest">
    <link rel="mask-icon" href="frontend/favicons/safari-pinned-tab.svg" color="#e30713">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#e30713">

    <script>
        // CI/CD Will Replace These Placeholders
        const FRONTEND_REDIRECT_BASE_URL = "__FRONTEND_REDIRECT_BASE_URL__";
        const LOGIN_HTML_PATH = "__LOGIN_HTML_PATH__";
        const BACKEND_URL = "__BACKEND_URL__"; // This one might already be managed by existing scripts
    </script>

    <link rel="stylesheet" href="css/vendors.min.css">
    <link rel="stylesheet" href="css/elements.min.css">
    <link rel="stylesheet" href="css/app.css">

    <style>
        .header-light { /* Style existing header for flex layout */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px; /* Adjust padding as needed */
            border-bottom: 1px solid #e5e7eb; /* Optional: adds a subtle line below header */
        }

        .header-light .logo img {
            height: 40px; /* Adjust logo height for better alignment */
            width: auto;
        }

        .user-info-logout-container {
            display: flex;
            align-items: center;
            gap: 15px; /* Space between elements */
        }
        .user-role {
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: #374151; /* gray-700 */
            padding: 6px 10px;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 6px; /* rounded-md */
            white-space: nowrap;
        }
        .profile-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ffffff; /* white border */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .profile-picture-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e5e7eb; /* gray-200 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-600 */
            border: 2px solid #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .profile-picture-placeholder svg {
            width: 24px; /* Adjust icon size if needed */
            height: 24px;
        }
        .logout-button {
            background-color: #ef4444; /* red-500 */
            color: white;
            font-weight: 500;
            font-size: 0.875rem; /* 14px */
            padding: 8px 16px; /* Slightly adjusted padding */
            border-radius: 8px; /* rounded-lg */
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .logout-button:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* --- Attempt to hide privacy pop-ups/cookie banners --- */
        /* Inspect the pop-up in your browser to find its specific ID or class if these don't work. */
        /* Common selectors for such elements: */
        .cookie-banner, .cookie-consent, .cookie-notice, .gdpr-banner, .privacy-popup, #cookieConsent, #privacyNotice {
            display: none !important;
        }

        /* Footer text font size reduction */
        .footer-legal p, .footer-legal-links a {
            font-size: 0.8rem; /* Adjust as needed */
        }

        /* Remove line from footer (border, shadow, or pseudo-elements) */
        .footer-light,
        .footer-light .container-grid { /* Target .container-grid specifically within .footer-light */
            border: none !important;
            box-shadow: none !important; /* Removes any box-shadow that might appear as a line */
        }

        /* Attempt to hide pseudo-elements that might be creating a line */
        .footer-light::before, .footer-light::after,
        .footer-light .container-grid::before, .footer-light .container-grid::after {
            display: none !important;
            content: "" !important; /* Ensure no content is rendered by them */
            border: none !important; /* Just in case they use borders */
        }
    </style>
</head>
<body>
    <p id="loading-indicator">Loading application...</p>
    <div id="app-root"></div>

    <header class="header header-light">
        <a class="logo" href="https://www.epfl.ch/en/">
		<img src="https://www.epfl.ch/wp-content/themes/wp-theme-2018/assets/svg/epfl-logo.svg" alt="Logo EPFL, École polytechnique fédérale de Lausanne" class="img-fluid">
	</a>
        <div class="user-info-logout-container">
            <span id="userRoleDisplay" class="user-role" style="display: none;"></span>
            <img id="profilePic" class="profile-picture" src="https://placehold.co/40x40/E2E8F0/4A5568?text=U" alt="User Profile Picture" style="display: none;">
            <div id="profilePicPlaceholder" class="profile-picture-placeholder" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <button id="logoutButton" class="logout-button">Logout</button>
        </div>
    </header>

    <footer class="footer footer-light pt-2 pb-2 bg-gray-100">
        <div class="container-grid">
            <div class="footer-legal">
                <div>
                    <p>&copy; EPFL 2024. All rights reserved.</p>
                </div>
                <div class="footer-legal-links">
                    <a href="https://www.epfl.ch/about/overview/fr/reglements-et-directives/" target="_blank" rel="noopener">Accessibility</a>
                    <a href="https://go.epfl.ch/privacy-policy" target="_blank" rel="noopener">Privacy policy</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/vendors.min.js"></script>
    <script src="js/elements.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingIndicator = document.getElementById('loading-indicator');
            const appRoot = document.getElementById('app-root');
            const userRoleDisplay = document.getElementById('userRoleDisplay');
            const profilePicImg = document.getElementById('profilePic');
            const profilePicPlaceholder = document.getElementById('profilePicPlaceholder');
            const logoutButton = document.getElementById('logoutButton');

            // Initial UI state
            loadingIndicator.style.display = 'block';
            appRoot.style.display = 'none';
            userRoleDisplay.style.display = 'none';
            profilePicImg.style.display = 'none';
            profilePicPlaceholder.style.display = 'flex'; // Show placeholder initially
            logoutButton.style.display = 'none';


            const showError = (message) => {
                console.error(message);
                // Potentially display error to user in a more friendly way
                loadingIndicator.textContent = message; // For example
            };

            const redirectToLogin = () => {
                // Ensure FRONTEND_REDIRECT_BASE_URL ends with a slash and LOGIN_HTML_PATH doesn't start with one.
                const base = FRONTEND_REDIRECT_BASE_URL.endsWith('/') ? FRONTEND_REDIRECT_BASE_URL : FRONTEND_REDIRECT_BASE_URL + '/';
                const path = LOGIN_HTML_PATH.startsWith('/') ? LOGIN_HTML_PATH.substring(1) : LOGIN_HTML_PATH;
                window.location.href = base + path;
            };

            try {
                // Ensure BACKEND_URL doesn't have a trailing slash
                const cleanBackendUrl = BACKEND_URL.replace(/\/$/, '');
                const authStatusUrl = `${cleanBackendUrl}/api/v1/auth/status`;

                const response = await fetch(authStatusUrl, {
                    method: 'GET',
                    credentials: 'include', // Send cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.log('Authentication failed, redirecting to login.');
                        redirectToLogin();
                    } else {
                        const errorText = await response.text();
                        showError(`Error fetching auth status: ${response.status} ${errorText}`);
                    }
                    return;
                }

                const userData = await response.json();

                // Populate app content from template
                const appTemplate = document.getElementById('app-template');
                if (appTemplate) {
                    const appContent = appTemplate.content.cloneNode(true);
                    appRoot.appendChild(appContent);
                } else {
                    showError('Error: Application template not found.');
                    return;
                }

                // Update UI with user data
                if (userData.user_role) {
                    userRoleDisplay.textContent = userData.user_role;
                    userRoleDisplay.style.display = 'inline-block';
                }
                if (userData.profile_picture_url) {
                    profilePicImg.src = userData.profile_picture_url;
                    profilePicImg.style.display = 'block';
                    profilePicPlaceholder.style.display = 'none';
                    profilePicImg.onerror = () => {
                        profilePicImg.style.display = 'none';
                        profilePicPlaceholder.style.display = 'flex';
                    };
                } else {
                    profilePicImg.style.display = 'none';
                    profilePicPlaceholder.style.display = 'flex';
                }

                // Show app and user elements, hide loading
                loadingIndicator.style.display = 'none';
                appRoot.style.display = 'block';
                logoutButton.style.display = 'block';


                // Attach event listeners for query form and logout button
                const queryForm = document.getElementById('query-form');
                if (queryForm) {
                    queryForm.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        const query = document.getElementById('query-input').value;
                        const responseArea = document.getElementById('response-area');
                        const geminiResponseElement = document.getElementById('gemini-response');

                        responseArea.style.display = 'block';
                        geminiResponseElement.textContent = 'Thinking...';

                        if (!query.trim()) {
                           geminiResponseElement.textContent = 'Please enter a question.';
                           return;
                        }

                       const formData = new FormData();
                       formData.append('question', query);

                       try {
                            const queryResponse = await fetch(cleanBackendUrl + '/api/v1/query', { // Assuming /api/v1/query for queries
                                method: 'POST',
                                body: formData,
                                credentials: 'include'
                            });

                            if (!queryResponse.ok) {
                                const errorText = await queryResponse.text();
                                throw new Error(`HTTP error! status: ${queryResponse.status} - ${errorText}`);
                            }

                            const data = await queryResponse.json();
                            let answer = data.answer ? data.answer.replace(/\*/g, '') : 'No answer received from Archie.';
                            geminiResponseElement.textContent = answer;
                            // Apply existing styling for response
                            geminiResponseElement.style.borderRadius = '10px';
                            geminiResponseElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                            geminiResponseElement.style.padding = '10px';
                            geminiResponseElement.style.whiteSpace = 'pre-wrap';
                            const queryInputElement = document.getElementById('query-input');
                            const queryInputComputedStyle = window.getComputedStyle(queryInputElement);
                            geminiResponseElement.style.fontFamily = queryInputComputedStyle.fontFamily;
                            geminiResponseElement.style.fontSize = queryInputComputedStyle.fontSize;
                            geminiResponseElement.style.lineHeight = queryInputComputedStyle.lineHeight;

                        } catch (error) {
                            console.error('Error querying Archie:', error);
                            geminiResponseElement.textContent = `Failed to get an answer. Error: ${error.message}`;
                        }
                    });
                } else {
                    showError("Error: Query form not found after loading template.");
                }

                if (logoutButton) {
                    logoutButton.addEventListener('click', async () => {
                        try {
                            const logoutUrl = `${cleanBackendUrl}/api/v1/auth/logout`;
                            const logoutResponse = await fetch(logoutUrl, {
                                method: 'POST', // Or GET, depending on your backend implementation
                                credentials: 'include'
                            });
                            if (logoutResponse.ok) {
                                redirectToLogin();
                            } else {
                                showError('Logout failed. Please try again or close your browser.');
                                console.error('Logout failed:', logoutResponse.status, await logoutResponse.text());
                                // Fallback, still try to redirect
                                redirectToLogin();
                            }
                        } catch (error) {
                            showError('Error during logout. Redirecting to login page.');
                            console.error('Error during logout:', error);
                            redirectToLogin();
                        }
                    });
                } else {
                     showError("Error: Logout button not found.");
                }

            } catch (error) {
                showError(`Initialization error: ${error.message}. Please try refreshing the page.`);
                // Optionally, redirect to login for any other critical errors during init
                // redirectToLogin();
            }
        });
    </script>

    <template id="app-template">
        <main class="main-container container-grid" role="main" id="main">
            <div class="container pt-5 pb-5"> <h1>Ask Archie</h1>
                <p class="lead">Enter your query below to get a response from Archie</p>
                <form id="query-form" class="mt-4">
                    <div class="form-group">
                        <textarea class="form-control" id="query-input" name="query" rows="3" placeholder="Ask any question here..." style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></textarea>
                    </div>
                    <button type="submit" class="logout-button mt-3">Send Query</button>
                </form>

                <div id="response-area" class="mt-5" style="display:none;">
                    <h2>Response</h2>
                    <pre><code id="gemini-response"></code></pre>
                </div>
            </div>
        </main>
    </template>

</body>
</html>