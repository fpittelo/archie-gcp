<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Archie MCP - Main Application</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #f4f4f4; color: #333; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; max-width: 600px; width: 90%;}
        .loading { font-size: 1.2em; color: #555; }
        .content { display: none; /* Hidden by default */ }
        .user-info img { border-radius: 50%; width: 50px; height: 50px; margin-bottom: 10px; border: 2px solid #ddd; }
        .user-info p { margin: 5px 0; }
        .logout-btn { padding: 10px 15px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 20px; font-size: 1em; }
        .logout-btn:hover { background-color: #c9302c; }
        h1 { color: #337ab7; }
        textarea { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: sans-serif;}
        button[type="submit"] { padding: 10px 20px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;}
        button[type="submit"]:hover { background-color: #4cae4c; }
        #gemini-response { margin-top: 15px; white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-message" class="loading">Checking authentication status... Please wait.</div>
        
    </div>

    <script>
        // IMPORTANT: Configure this to your backend's base URL.
        // This is the URL where your Flask application (main.py) is served.
        // Example for Cloud Run: "https://your-service-name-xyz.a.run.app"
        // Example for local dev: "http://localhost:8080" (if main.py runs on port 8080)
        // If this index.html is served from the same origin as the backend (e.g. Flask serves static files),
        // you can use "" (empty string) or "/". For CI/CD, a placeholder is best.
        const API_BASE_URL = '__BACKEND_URL__'; // <-- This will be replaced by your CI/CD pipeline

        // Fallback login page URL (relative to this index.html file's location)
        // This is used if the backend doesn't provide a specific redirectTo URL for login.
        const FALLBACK_LOGIN_PAGE = 'login.html'; 

        // Target page if authentication is successful (relative to this page's location)
        const TARGET_INDEX_PAGE = 'index.html';

        async function checkAuthStatus() {
            const loadingMessage = document.getElementById('loading-message');

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/status`, {
                    credentials: 'include', // Crucial for sending session cookies
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated && data.user) {
                        // User is authenticated, redirect to the main application page
                        window.location.href = TARGET_INDEX_PAGE;
                    } else {
                        // Should ideally not happen if backend returns 200 OK with authenticated: false
                        redirectToLogin(data.redirectTo);
                    }
                } else if (response.status === 401) {
                    const data = await response.json();
                    redirectToLogin(data.redirectTo);
                } else {
                    console.error('Error checking auth status:', response.status, await response.text());
                    loadingMessage.textContent = `Error ${response.status}: Could not verify authentication status.`;
                }
            } catch (error) {
                console.error('Network or other error fetching auth status:', error);
                loadingMessage.textContent = 'Service unavailable. Please check your network or try again later.';
                // You might want to offer a manual link to the login page here too.
            }
        }

        function redirectToLogin(backendRedirectUrl) {
            let loginUrl = backendRedirectUrl;
            if (!loginUrl) {
                // Fallback if the backend didn't provide a URL.
                // Assumes login.html is relative to the current page's location.
                const currentPath = window.location.pathname;
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                loginUrl = basePath + FALLBACK_LOGIN_PAGE;
                console.warn(`Backend did not provide a redirect URL for login. Falling back to: ${loginUrl}`);
            }
            window.location.href = loginUrl;
        }

        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html>